# 项目计划

## 任务分配
### 阶段开发任务

#### 第0阶段

梳理原型系统的代码和流程，为正式开发做好准备。

#### 第1阶段

完成从下投资指令开始到投资指令处理完成的整个流程的基本实现。

* 投资服务
  * 多资管公司支持
  * 创建投资指令草稿
  * 更新指令草稿
  * 提交投资指令
  * 创建委托分配计划
  * 分配交易员
* 交易服务
  * 实现上证A股竞价交易服务
  * 计算投资指令所需资源（钱、仓）
  * 提交资源申请单至资源队列
  * 产生虚拟成交
  * 成交处理
  * 基本交易参数处理
  * 基本交易日历处理
  * 基本的盘后清算
* 资金持仓服务
  * 从资源队列获取新的资源申请单并进行处理
  * 资金持仓服务将处理结果告知交易服务
  * 基本的盘后清算
* 行情服务
  * 实现行情接口
* Web前台
  * 相关界面的基本功能实现

#### 第2阶段

对系统进行进一步的完善和打磨。

* 更多交易服务、事务服务的实现
* 增加标的组支持
* 完善委托分配计划
* 报盘服务实现
* 行情服务实现
* 认证权限服务实现
* 数据分析、报表服务实现
* Web界面的细节打磨

### 并行任务

并行任务将贯穿各个阶段。部分并行任务与阶段开发任务有相互依赖关系。

#### 开发环境搭建

理论上来说，开发环境搭建应该在大规模开发之前完成。在实际开发过程中，由于资源限制，可以考虑开发先在外网环境启动。内网开发环境搭建同步进行。待开发环境搭建完成后，项目整体由外网迁移至内网。搭建过程中需要考虑到迁移时尽量少修改项目本身。

* 服务器资源准备
* 版本管理工具
* 持续集成工具
* docker仓库
* maven仓库
* npm仓库
* 开发测试环境（？）

#### 持续集成流程实施

目前我们的持续集成流程主要是针对测试与发布。因此理论上来书可以在测试介入之前完成。但目前发现整个系统资源占用较大，实际开发时可能需要有一个独立的测试环境供给开发人员自己测试用，而测试环境的部署也可以纳入持续集成流程进行自动化管理。因此持续集成流程完成得越早越好。持续集成流程在原型阶段有初步的实现，完整的实现可以基于此进行完善。部署流程设计可以跟项目开发同时进行。流程设计完成后即可介入开发流程，跟随项目发展逐步演进。在流程设计完成之前

* 在持续集成工具上配置开发，实现之前设计的持续集成流程
* 开发测试环境部署流程的设计
* 生产环境部署流程的设计
* 流程配套脚本的开发
* 相关资源的版本管理方案

#### 测试方案及实施

新架构中计划的发布模式为持续发布，因此原系统那种一个版本发布前开始测试的模式不适合在新架构中使用。在发布开始后，测试和发布将是一个常态化过程。测试人员需要在首次发布前规划好整个测试方案。方案将以自动化回归测试为主，辅以人工测试，配合持续集成尽可能自动化的完成。一个测试的周期通常会在1-2天内就结束。测试方案的设计可以在项目基本成型后开始，方案设计完成后配合持续集成工具介入，跟随项目功能的逐步完善而演进。

这里也要提一下单元测试方案。在本系统中，单元测试应该可以起到两个作用，第一个作用是保证软件开发的最基本的质量，第二个作用是在依赖服务不可用的情况下进行有效开发。这也是单元测试方案在设计时需要注意的两点。单元测试方案的设计由开发组负责。

* 单元测试方案的设计
* 集成测试方案的设计
* 在持续集成工具上配置开发
* 流程配套脚本的开发
* 测试用例的编写
* 相关资源的版本管理方案

#### 运维方案及实施

新系统是基于微服务架构进行设计的，在微服务架构中，由于系统的复杂性和远程相互依赖，运维是整个系统正常运行不可或缺的一部分。运维方案需要在产品正式发布前完成。并且运维方案也需要同步部署到测试环境中作为测试环境的一部分。在原型开发时仅仅简单涉及了服务发现和服务编排。正式环境中需要更完善的服务编排工具。在做运维方案设计时，需要考虑服务器资源的问题。目前客户的服务器资源是极为有限的，可能只有一台最多两台服务器。因此运维工具自身不能占用太多资源。另外，需要考虑公司集中运维的方案。运维方案可以跟项目开发同步进行。随时可以介入。

* 运维方案的设计相关工具的部署与配置
* ·配套脚本的开发
* 相关资源的版本管理方案

#### 培训

新系统采用了目前较新的技术，因此对于开发人员、测试人员、运维人员和实施人员的培训也是必不可少的。开发培训需要在大规模开发之前完成。其他培训视情况。

* **Java端开发培训**
* **Java端开发培训**
* **前端开发培训**
* 测试技术培训
* 运维技术培训

所有的培训都分成方案设计及实施两个部分。

#### 项目管理

目前在小团队中没有严谨的项目管理方案，基本上以敏捷模式为主。大规模开发时需要更严谨的项目管理方案。项目管理方案可以与开发并行设计，设计完成后介入，并在开发过程中逐步演进。

* 项目管理方案设计
* 项目管理工具部署及配置

- 项目计划制定与跟踪

## 工作量预估

### 开发任务

#### 第0阶段

前后台部分可以并行处理。整个第0阶段5天可以完成。

* 后台原型代码整理5人天


* 前台原型代码整理5人天

#### 第1阶段

前后台由不同开发人员负责。前台开发依赖后台，但前台开发量相对较少，基本上可以紧跟后台进度。这里将前后台的工作量设置成相同时间。整个第1阶段计划3周完成。需要注意的是，一部分因为工作量而暂时不实现的功能，需要考虑事先预留接口。以减少后续完善时的改动。

* 后台基本流程实现15人天
* 前台基本流程界面实现15人天

#### 第2阶段

第2阶段是功能全面铺开，开发人员大规模参与的一个阶段，大任务比较多，任务涉及的细节也多，很难清楚的估计工作量。这里仅对各服务展开分析，并给出大致的工作量范围。具体工作量日后再确定。

##### 投资服务

投资服务在第1阶段开发完成后大致成型，第2阶段主要是补完的工作。这里的工作量相对于整个第2阶段工作量可以暂时忽略不计。

##### 交易服务

交易服务需要完整实现以下功能：

```
上证A股竞价交易服务
上证A股首次网上公开发行交易服务
上证港股通竞价交易服务
上证基金竞价交易服务
上证交易型货币基金申赎交易服务
上证股票ETF申赎交易服务
上证债券ETF申赎交易服务
上证LOF场内申赎交易服务
上证债券竞价交易服务
上证债券质押式回购竞价交易服务
上证股票期权竞价交易服务

深证A股竞价交易服务
深证A股首次网上公开发行交易服务
深证港股通竞价交易服务
深证基金竞价交易服务
深证交易型货币基金申赎交易服务
深证股票ETF申赎交易服务
深证黄金ETF申赎交易服务
深证债券ETF申赎交易服务
深证LOF场内申赎交易服务
深证债券竞价交易服务
深证债券质押式回购竞价交易服务

中金所股指期货竞价交易服务
中金所国债期货竞价交易服务
郑商所商品期货竞价交易服务
大商所商品期货竞价交易服务
上期所商品期货竞价交易服务

港交所股票竞价交易服务
自定义标的交易服务
```

共29个。

在第1阶段中，上证A股竞价交易服务应该已经有了一个基本的实现。因此在第2阶段中，我们一方面需要进一步完善这个实现，另一方面，可以以这个实现为蓝本实现其他的交易服务。

在第2阶段，我们需要完善交易服务的地方主要是：

* 标的组功能。标的组的引入涉及标的组的生成，否则没法实际使用。而标的组的生成又依赖标的基础信息，标的基础信息是从行情服务获得，所以必须依赖行情服务的实现。
* 完整的清算服务。清算服务也依赖行情。还依赖交易参数（保证金等），部分交易服务的清算还依赖额外信息（如大边保证金计算时需要的套利组合信息），需要额外开发。
* 完整的交易参数功能。
* 完整的交易日历功能。
* 其他。

在单个交易服务完善的基础上，以单个交易服务为蓝本，实现其他交易服务相对比较方便。一部分交易服务有类似性，只需要复制代码做一些简单的调整。一部分交易服务可能需要从头设计，从头开发。

交易服务的另一个特点是基本上可以完全并行开发。不太可能产生冲突。因此可以通过投入更多资源来加速开发。但前提是单一的交易服务已经开发完善。

单一交易服务开发完善依赖行情服务。假设行情服务已经开发完成，估计单一交易服务完善需要30人天。

然后按全部交易服务的数量，以及平均估计，这些交易服务开发完成大约需要300人天。

##### 资金持仓服务

资金持仓服务中，持仓服务部分基本上一个交易服务就对应一个持仓服务，资金服务相对较少。但新增一个交易服务需要增加一个持仓服务，并要实现该持仓服务相关指标的计算逻辑。

资金持仓服务与交易服务一样，持仓服务开发相对独立，可以并行。可以通过增加资源的形式加快开发速度。

平均一个持仓服务按5人天计算，大致需要150人天。

##### 时序服务

时序服务在原型开发阶段已经提供了序号(版本号)的功能，在第1阶段开发时应该已经加入了定时触发的功能。（因为需要实现清算）。

在第2阶段，时序服务可以暂时不做改进，或者在有多余资源的情况下，做高可靠性方面的增强工作。

目前暂时不计算工作量。

##### 行情服务

在第2阶段，鉴于不少功能都依赖行情服务，行情服务的优先级是比较高的。行情服务对其他服务基本没有依赖。

行情服务在第1阶段应该已经定义好了接口。依赖行情服务的功能可以暂时先根据接口进行开发。但行情仍然需要尽快可以拿出可以获取实际数据的版本。

行情服务分成公共行情服务和系统行情服务两个组件。两个组件间也以接口的形式进行通讯。但鉴于两个组件联系的紧密性，建议交给单个开发人员或开发小组进行开发。避免协作上的不流畅。

公共行情服务主要负责

* 收取行情源数据
* 接受系统行情服务的实时行情订阅请求（支持增量订阅）
* 根据订阅请求推送相应标的的实时行情快照（一次）及后续行情变化
* 接受系统行情服务的实时行情查询请求
* 返回实时行情查询结果
* 接受系统行情服务的标的基础信息查询请求
* 返回标的基础信息查询结果

系统行情服务主要负责

* 提供标的基础信息查询接口，转发标的基础信息查询结果
* 提供实时行情查询接口，转发实时行情查询结果
* 将收取到的实时行情保存为历史，并提供历史行情查询接口
* 提供实时行情订阅接口，将不同的订阅请求合并后向公共行情服务进行订阅
* 将从公共行情服务收到的实时行情推送转推给各个订阅源。

整个开发在行情源已经准备完成的情况下，大致估计在60人天。但由于行情源是第三方接口，接口联调的时间难以估计。

##### 报盘服务

报盘服务主要负责跟柜台或PB系统的交互。按现有系统的状况，可以分两个阶段。第一个阶段是完成成交回报的获取，以及保证金信息的获取。第二个阶段是完成委托的处理。第一阶段应该尽早完成。

报盘服务需要完成：

* 成交回报的获取与推送
* 成交回报的查询
* 保证金信息的获取与推送
* 保证金信息的查询
* *委托处理*
* *撤单处理*

第一阶段大致估计在30人天，第二阶段大致估计在10人天。根据对接系统API的不同，接口联调难度也不同，具体联调时间难以估计。

##### 风控服务

主要用于风控。风控系统相对独立，优先级相对较低。

由投资服务触发启动。风控服务启动后向其他服务请求相关指标并进行风险判断。判断完成后向投资服务及前台推送风控结果，同时将风控结果保存备查。

需要完成的工作：

- 实现启动、停止风控接口
- 实现查询风控结果的接口
- 实现风控Lua脚本执行环境
- 实现风控Lua脚本的上传及管理
- 调用其他组件的接口获得相关指标
- 向前台通知风控结果

其中集成Lua脚本执行环境需要研究，最理想的情况，风控Lua脚本可以复用现有系统的，不需要改动；不理想的情况是Lua脚本需要根据新的运行环境做调整。在不增加新风控脚本的情况下，时间大致估计在40-50人天。

##### 产品管理服务

产品管理服务相对独立，但细节较多。产品管理服务是众多服务的基础信息来源，优先级较高。但产品管理服务可以渐进式开发，优先开发其他服务所需的核心信息。周边的信息可以暂缓。

产品管理服务主要就是数据库的增删改查，没有技术上的难点。并且现在已经实现了一部分核心的数据提供。

在第1阶段中，产品管理服务应能提供基础流程所需的核心数据。

第2阶段，产品管理服务可以逐步完善。

完整的开发周期应该较长，但应该可以及时拿出其他服务所需的接口。目前不定义具体的工作量，只定义成不会大幅影响其他组件的开发计划。

##### 权限认证服务

权限认证服务需要重新做一个完整通用的设计，这个周期会相对较长。实现方面应该不会有太多技术上的难点。可以考虑基于现有的权限认证框架如Spring Security、Apache Shiro等进行开发。

权限认证开发完成后，相关服务都需要进行接口的调整。由于权限认证服务的接口无法在短期内确定，只能在设计完善后再进行修改，这里也需要一定的工作量。

权限认证服务本身大致估计的工作量是30人天。其他服务的跟随修改视当时的开发规模而定。暂定也是30人天。

##### 事务服务

事务服务需要完整实现以下功能：

```
上证A股分红事务服务
上证债券质押式回购质押出库事务服务
上证债券质押式回购质押入库事务服务
上证A股指定交易事务服务

深证A股分红事务服务
深证A股转托管事务服务
深证债券质押式回购质押出库事务服务
深证债券质押式回购质押入库事务服务

中金所股指期货交割事务服务
中金所国债期货交割事务服务
```

共10个。

事务服务在现有系统中没有实现，因此需要重新进行设计。而且每一个事务服务都是不同的，需要独立进行设计。

事务服务目前连总控程序都不存在，可以从交易服务借鉴，完成总控程序，大约需要5人天。

具体事务服务按平均20人天（包含设计）计算，全部完成需要200人天。

事务服务也是可以通过多分配资源来加速开发的。



### 并行任务

待续

## 资源预估

