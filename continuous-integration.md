# 版本管理及持续集成设想

## 版本管理

系统采用微服务架构，通过`gitlab`对版本进行管理。整个系统是一个独立的版本仓库。每一个组件是一个单独的文件夹。每一个组件都可以独立编译。版本仓库有3个长期分支：主线分支`master`、集成分支`migrate`和发布分支`release`。

主线分支用于开发，集成分支用于测试，发布分支用于发布及部署。

### 开发过程

为了避免分支污染及有效控制代码质量，各开发人员均fork一份代码库自行管理。原则上每一个新功能或较大修改都创建一个分支进行修改，一些小的修改可以直接在主线上进行。待开发完成后，向主版本提交`Merge Request`。代码审核人员对每一个`Merge Request`进行审核，审核通过可以进入主线分支。审核未通过的可以进一步修改，直至通过。如果某个Request是不必要的，也可以暂缓合并或者直接撤回。开发人员提交`Merge Request`时，必须关联对应的`issue id`。一个`Merge Request`解决一个issue。一旦合并进入主线，持续集成工具将自动集成此次提交。如果集成失败则需要开发人员进行修改，直至集成成功。集成成功后，原分支将被关闭或删除。避免污染时间线。

所有的开发都必须从建立`issue`开始。issue的建立人可以是需求、测试、开发者或各类流程管理工具（自动化创建issue）。issue的内容可以是需求、bug或改进。issue由issue管理工具进行管理，这里不再赘述。issue管理工具必须能与gitlab及持续集成工具整合。为简化起见，初期可以直接使用gitlab自带的issue管理功能。

以上开发过程借鉴自[gitlab flow](https://www.15yan.com/story/6yueHxcgD9Z/)。更详细的gitlab flow使用流程可以参考原文。（我们的migrate和release分支对应于文中的preproduction和production分支）

### 发布过程

系统发布采用持续发布模式与版本发布模式相结合。每一个组件都需要定义自己独立的版本号。版本号循[语义化版本规范](http://semver.org/lang/zh-CN/)。开发提交经开发审核人员审核通过进入主线分支后（此过程下文详述），对于阶段性的成果，合并至集成分支，此合并动作将触发持续集成工具进行编译集成。

如果本次提交主版本号不变（意味着接口向下兼容），则进入持续发布流程。集成完毕后，测试人员可以对集成结果进行自动化或手工的测试。测试通过之后，测试审核人员将选择是否将此次提交合并至产品分支。如果合并至产品分支，则持续集成工具会对产品分支的此次提交进行编译集成，形成发布结果。部署人员可以将此发布结果发布至客户服务器。每一个集成结果均包含构建号`BUILD_NUMBER`，用于版本的跟踪。

如果本次提交主版本号发生变化（意味着接口兼容性被破坏），则进入版本发布流程。提交人必须通知其它**所有**组件开发者主版本号升级。使用原接口的相关组件必须同步升级，改成使用新接口，并提升自己的版本号。其他非相关组件也需要更新自己的版本号。在版本发布时，**所有组件**（即使没有更改代码的组件）都必须经历一次编译，将版本号升级到新主版本号。全部新版本组件作为一个整体进行测试、发布和部署。（就像一次全新的部署一样。）

所有组件需要提供一个`version`接口，以便在运行时查询自身的版本号。

### 持续集成过程

持续集成过程由`Jenkins`进行管理。使用代码提交驱动。当对应分支的代码提交后，持续集成工具首先获取整个项目代码，然后判断哪个目录中的文件发生了变化，然后开始编译变化了的组件。编译完成之后需要自动进行单元测试、组件测试和接口测试，并判断单元测试覆盖率。测试未通过或覆盖率未达标则此次编译失败。

持续集成分别对代码仓库的`master`、`migrate`、`release`三个分支进行自动化编译，编译结果分别用于开发检验、测试和发布。

编译成功后，视需要对编译结果进行docker打包及分发至内部docker registry。以供后续使用。