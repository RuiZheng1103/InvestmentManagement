# 版本管理及持续集成设想

## 版本管理

系统采用微服务架构，通过gitlab对版本进行管理。每一个组件拥有独立的版本仓库。独立提交，独立编译。每个组件有3个长期分支：主线分支`master`、集成分支`migrate`和发布分支`release`。

### 发布过程

系统采用持续发布模式。开发提交经开发审核人员审核通过进入主线分支后（此过程下文详述），对于阶段性的成果，合并至集成分支，此合并动作将触发持续集成工具进行编译集成。集成完毕后，测试人员可以对集成结果进行自动化或手工的测试。测试通过之后，测试审核人员将选择是否将此次提交合并至产品分支。如果合并至产品分支，则持续集成工具会对产品分支的此次提交进行编译集成，形成发布结果。部署人员可以将此发布结果发布至客户服务器。每一个集成结果仅包含构建号`BUILD_NUMBER`，用于版本的跟踪。

#### 接口兼容性问题

由于组件间的交互是通过接口，当接口兼容性遭到破坏时，可能导致整个系统无法正常工作。因此对于接口兼容性遭遇破坏的情况，开发审核人员有责任等待所有相关组件都升级完成之后再提交至集成分支。测试人员也需要对每一次提交进行（自动的）接口回归测试，以及时发现接口兼容性遭遇破坏的情况。

### 开发过程

为了避免分支污染及有效控制代码质量，各开发人员均fork一份代码库自行管理。原则上每一个新功能或较大修改都创建一个分支进行修改，一些小的修改可以直接在主线上进行。待开发完成后，向主版本提交`Merge Request`。代码审核人员对每一个`Merge Request`进行审核，审核通过可以进入主线分支。审核未通过的可以进一步修改，直至通过。如果某个Request是不必要的，也可以暂缓合并或者直接撤回。开发人员提交`Merge Request`时，必须关联对应的`issue id`。一个`Merge Request`解决一个issue。一旦合并进入主线，持续集成工具将自动集成此次提交。如果集成失败则需要开发人员进行修改，直至集成成功。

所有的开发都必须从建立`issue`开始。issue的建立人可以是需求、测试、开发者或各类流程管理工具（自动化创建issue）。issue的内容可以是需求、bug或改进。issue由issue管理工具进行管理，这里不再赘述。issue管理工具必须能与gitlab及持续集成工具整合。

### 遗留问题

* 对于比较大的issue，改动变化可能较多，如何有效审查？
* 各个组件是独立的版本仓库，但issue需要整合，否则在哪个组件中提issue会变成一个问题。因此可能还是需要引入外部的issue管理工具。
* 自动测试时测试环境的构建（Docker in Docker?）
* 自动构建是以系统整体作为单位还是以组件作为单位？
  * 以组件为单位更体现持续发布的优势。但以组件为单位后，组件如何获知其相关联组件的信息？（接口兼容性中提到的问题）

